{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src = "{% static 'jszip.js' %}"></script>
    <script src = "{% static 'fzz-loader.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fast-xml-parser/3.17.5/parser.js" integrity="sha512-+oa7q7U+mv1Z24WZgSomOxNIdfT9PeHi5CYrpQiqr1yU5c94QfcoiLVOqQheSpCknMO0kChujWBzfcXUk8dLhA==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/txml@4.0.0/tXml.min.js" integrity="sha256-JVxBZ4O0VyKbBrtpGknLb74c7h/KaxSWs86afZhn1Ls=" crossorigin="anonymous"></script>
    <title>fritzing File</title>
  </head>
  <body>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <!-- Option 2: Separate Popper and Bootstrap JS -->
    
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js" integrity="sha384-q2kxQ16AaE6UbzuKqyBE9/u/KzioAlnx2maXQHiDX9d4/zp8Ok3f+M7DPm+Ib6IU" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-pQQkAEnwaBkjpqZ8RU1fF1AKtTcHJwFl3pblpTlHXybJjHpMYo79HY3hIi4NKxyj" crossorigin="anonymous"></script>
    -->
    <div class="container">
        <center>
            <div class="card">
                <h1>Select A fritzing File to view.</h1>
                <div class="card-body">
                <input type="file" name="inputfile" id="inputfile">
                </div>
            </div>
        </center>  
    </div>
    <script>
        document.getElementById('inputfile').addEventListener('change', function () {
            var array = new FileReader();
            array.onload = function () {
                var data = array.result;
                console.log(data)
                readFZZ(null, data, (fzz) => {
                    console.log("FZZ", fzz);
                    console.log("End of fzz")
                });
            }
            array.readAsArrayBuffer(this.files[0]);
        });

        function readFZZ(url, data, cb) {
            let tmpFZZ = new FZZ();
            tmpFZZ.uri = url;
            // cb(tmpFZZ)
            let Zip = new JSZip();
            Zip.loadAsync(data).then((zip) => {
                tmpFZZ.zip = zip;
                // console.log('ZIP', zip);
                // console.log('FZZ Files:', zip.files);

                let totalFiles = Object.keys(zip.files).length;
                // console.log('TOTAL FILES', totalFiles);
                // let counter = 0;
                console.log(zip);
                for (var filename in zip.files) {
                    if (zip.files.hasOwnProperty(filename)) {
                        // add each filename to the files array...
                        tmpFZZ.files.push(filename);

                        // check the file extension
                        let ext = filename.split('.').pop();
                        // console.log(counter, 'FILENAME', filename, ext);

                        switch (ext) {
                            case 'fz':
                                //console.log('fz data');
                                tmpFZZ.fz.filename = filename;
                                //console.log(zip.files[filename]._data);
                                zip.file(filename).async('string').then(function success(text) {
                                    var data = parseFZ(filename, text);
                                    console.log('End')
                                    tmpFZZ.fz = data;

                                    //         //   // }
                                });
                            //
                                   //  break;
                            //
                            case 'fzp':
                                // TODO: load fzp
                                console.log('FZP', filename);
                                break;

                            case 'svg':
                                // TODO: loadsvg
                                console.log('SVG', filename);
                                break;

                            case 'ino':
                                console.log('CODE', filename);
                                //         // zip.file(filename).async('string').then(function success(text) {
                                //         // //   counter++;
                                //         // //   // console.log(counter);
                                //         //   tmpFZZ.code.addSource(filename, text);
                                //         // //   // if (counter === totalFiles) {
                                //         // //   //   cb(tmpFZZ);
                                //         // //   // }
                                //         // });
                                break;

                            default:
                                throw new Error('filetype not supported');
                        }
                    }
                } // end for
                console.log(tmpFZZ);
                //cb(tmpFZZ);
            }).catch((e) => {
                throw e;
            });
        }
    </script>
       
  </body>
</html>
